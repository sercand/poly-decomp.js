<!DOCTYPE html>
<html>

<head>
    <title>poly-decomp.js</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0px;
            padding: 0px;
            overflow: hidden;
            font: 13px Helvetica, arial, freesans, clean, sans-serif;
        }
        
        p,
        h1 {
            margin-bottom: 5px;
        }
        
        #info {
            display: block;
            background-color: #eee;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="info">
        <form action='#' onsubmit="return false;">
            <input type='file' id='imgfile' />
            <input type='button' id='btnLoad' value='Load' onclick='loadImage();' />
        </form>
        <p></p>
        <p>step:</p>
        <p id="output">[]</p>   
    </div>

    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script src="build/decomp.js"></script>
    <script src="dat.gui.js"></script>
    <script>
        var path = [],
        polys = [],
        mousedown = false,
        img = null,
        colors = ["#f99","#9f9","#99f","#ff9"];

    var canvas = document.createElement('canvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    $("body").append(canvas);


    function printRender(){
        var res = []
        for(var i=0; i < polys.length; i++){
            var p = polys[i];
            res.push({x: p[0] , y: p[1]})
        }
        document.getElementById("output").innerHTML = JSON.stringify(res);
    }

    function render() {
        var c = canvas.getContext('2d');

        // clear
        c.clearRect(0, 0, canvas.width, canvas.height);
        
        if(img){
            c.drawImage(img, 0, 0);
        }
        
        c.fillStyle = "red";
        c.strokeStyle = "black";
        
        for(var i=0; i < polys.length; i++){
            var p = polys[i];
            c.beginPath();
            c.arc(p[0],p[1],3,0,2*Math.PI);
            c.fill();
        }
    }
    render();

    // Setup GUI
    var settings = {
        minEdgeLength : 50,
        quickDecomp : true,
        removeCollinear:true,
        collinearThreshold:0.001,
        clear : function() { 
            polys = [];
            render();
            printRender();
        }
    };
    var gui = new dat.GUI();
    gui.add(settings, 'clear');
    
    function imageLoaded() {
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img,0,0);
    }
    
    function getMousePos(e){
        var offset = $(e.target).offset();
        return [e.clientX - offset.left,e.clientY - offset.top];
    }

    $("canvas").mousedown(function(e){
        polys.push(getMousePos(e))
        printRender();
        render();
    })
    
    
    function loadImage() {
        var input, file, fr;

        if (typeof window.FileReader !== 'function') {
            write("The file API isn't supported on this browser yet.");
            return;
        }

        input = document.getElementById('imgfile');
        if (!input) {
            write("Um, couldn't find the imgfile element.");
        }
        else if (!input.files) {
            write("This browser doesn't seem to support the `files` property of file inputs.");
        }
        else if (!input.files[0]) {
            write("Please select a file before clicking 'Load'");
        }
        else {
            file = input.files[0];
            fr = new FileReader();
            fr.onload = createImage;
            fr.readAsDataURL(file);
        }

        function createImage() {
            img = new Image();
            img.onload = imageLoaded;
            img.src = fr.result;
        }

        function write(msg) {
            console.log(msg)
        }
    }
    </script>
</body>

</html>